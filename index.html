<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NASA VR Solar System - AI Exoplanet Explorer</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body>
  <a-scene background="color: black">

    <a-assets>
      <img id="skyTexture" src="/static/textures/sky.jpg">
      <img id="labelBgTexture" src="/static/textures/labeeeel.png">
      <audio id="soundtrackAudio" src="/static/soundtrack.mp3" preload="auto"></audio>
      <img id="tex1" src="/static/textures/1.jpeg">
      <img id="tex2" src="/static/textures/2.jpeg">
      <img id="tex3" src="/static/textures/3.jpeg">
      <img id="tex4" src="/static/textures/4.jpeg">
      <img id="tex5" src="/static/textures/5.jpeg">
      <img id="tex6" src="/static/textures/6.jpeg">
      <img id="tex7" src="/static/textures/7.jpeg">
      <img id="tex8" src="/static/textures/8.jpeg">
      <img id="tex9" src="/static/textures/9.jpeg">
      <img id="tex10" src="/static/textures/10.jpeg">
    </a-assets>

    <a-sky src="#skyTexture"></a-sky>
    <a-entity light="type: ambient; color: #666"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.4" position="-1 1 0.5"></a-entity>
    <a-entity light="type: point; intensity: 2; distance: 100; decay: 2; color: #fff" position="0 0 0"></a-entity>
    <a-entity id="planets"></a-entity>
    
    <a-entity id="rig" position="0 6 15" rotation="-10 -20 0">
      <a-camera id="camera" wasd-controls-enabled="true" look-controls="true">
        <a-cursor raycaster="objects: .planet"></a-cursor>
      </a-camera>
      
      <a-entity id="info-panel" position="2.2 1.3 -2.5" rotation="0 -30 0" visible="false" material="opacity: 0" scale="0.8 0.8 0.8"
                animation__open_fade="property: material.opacity; to: 0.9; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_fade="property: material.opacity; to: 0; startEvents: close-panels; dur: 300; easing: easeInCubic"
                animation__open_scale="property: scale; to: 1 1 1; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_scale="property: scale; to: 0.8 0.8 0.8; startEvents: close-panels; dur: 300; easing: easeInCubic">
        <a-plane width="2" height="1.0" material="src: /static/textures/labeeeel.png; transparent: true" side="double"></a-plane>
        <a-text id="info-title" value="Gezegen Adı" color="#FFF" align="center" width="1.9" position="0 0.35 0.01" font="mozillavr" shader="msdf"></a-text>
        <a-text id="info-text" value="Açıklama" color="#FFF" align="left" width="1.8" position="-0.9 -0.05 0.01" wrap-count="35"></a-text>
      </a-entity>

      <a-entity id="light-curve-panel" position="-2.2 1.3 -2.5" rotation="0 30 0" visible="false" material="opacity: 0" scale="0.8 0.8 0.8"
                animation__open_fade="property: material.opacity; to: 0.75; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_fade="property: material.opacity; to: 0; startEvents: close-panels; dur: 300; easing: easeInCubic"
                animation__open_scale="property: scale; to: 1 1 1; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_scale="property: scale; to: 0.8 0.8 0.8; startEvents: close-panels; dur: 300; easing: easeInCubic">
          <a-plane width="2.2" height="1.0" color="#050505"></a-plane>
          <a-text value="LIGHT CURVE ANALYSIS" color="#00ffff" position="0 0.4 0.01" align="center" width="3.5" font="mozillavr" shader="msdf"></a-text>
          <a-plane width="2.0" height="0.01" position="0 0.2 0.01" color="#00ffff" material="opacity: 0.2"></a-plane>
          <a-plane width="2.0" height="0.01" position="0 0.05 0.01" color="#00ffff" material="opacity: 0.2"></a-plane>
          <a-plane width="2.0" height="0.01" position="0 -0.1 0.01" color="#00ffff" material="opacity: 0.2"></a-plane>
          <a-plane width="0.01" height="0.7" position="0 0.05 0.01" color="#00ffff" material="opacity: 0.2"></a-plane>
          <a-entity id="light-curve-path"></a-entity>
          <a-entity id="light-curve-tracer" geometry="primitive: sphere; radius: 0.03" material="color: #00ffff; shader: flat" glow="color: #00ffff; intensity: 2.0"></a-entity>
      </a-entity>

      <a-entity id="astro-panel" position="-2.2 0.1 -2.5" rotation="0 30 0" visible="false" material="opacity: 0" scale="0.8 0.8 0.8"
                animation__open_fade="property: material.opacity; to: 0.75; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_fade="property: material.opacity; to: 0; startEvents: close-panels; dur: 300; easing: easeInCubic"
                animation__open_scale="property: scale; to: 1 1 1; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_scale="property: scale; to: 0.8 0.8 0.8; startEvents: close-panels; dur: 300; easing: easeInCubic">
          <a-plane width="2.2" height="1.0" color="#050505"></a-plane>
          <a-text value="ASTROPHYSICAL DATA" color="#ffa500" position="0 0.35 0.01" align="center" width="3.5" font="mozillavr" shader="msdf"></a-text>
          <a-text id="astro-text" value="Veriler yükleniyor..." color="#FFF" align="left" width="2.8" position="-1.0 -0.05 0.01" wrap-count="50"></a-text>
      </a-entity>

      <a-entity id="ai-panel" position="2.2 0.1 -2.5" rotation="0 -30 0" visible="false" material="opacity: 0" scale="0.8 0.8 0.8"
                animation__open_fade="property: material.opacity; to: 0.75; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_fade="property: material.opacity; to: 0; startEvents: close-panels; dur: 300; easing: easeInCubic"
                animation__open_scale="property: scale; to: 1 1 1; startEvents: open-panels; dur: 400; easing: easeOutCubic"
                animation__close_scale="property: scale; to: 0.8 0.8 0.8; startEvents: close-panels; dur: 300; easing: easeInCubic">
          <a-plane width="2.0" height="0.5" color="#050505"></a-plane>
          <a-text value="AI CONFIDENCE" color="#00ff7f" position="0 0.15 0.01" align="center" width="3.5" font="mozillavr" shader="msdf"></a-text>
          <a-plane id="ai-progress-bg" width="1.8" height="0.1" position="0 -0.1 0.01" color="#FFF" material="opacity: 0.2"></a-plane>
          <a-plane id="ai-progress-bar" width="0" height="0.1" position="-0.9 -0.1 0.02" color="#00ff7f" material="shader: flat"></a-plane>
          <a-text id="ai-progress-text" value="0.00%" color="#FFF" position="0 -0.1 0.03" align="center" width="4"></a-text>
      </a-entity>

      <a-entity laser-controls="hand: right" raycaster="objects: .planet" scale="0.5 0.5 0.5"></a-entity>
      <a-entity laser-controls="hand: left" raycaster="objects: .planet" scale="0.5 0.5 0.5"></a-entity>
    </a-entity>

    <a-entity sound="src: #soundtrackAudio; autoplay: true; loop: true; volume: 0.5"></a-entity>

    <script>
        // --- Global Değişkenler ---
        const planetsContainer = document.querySelector("#planets");
        const sceneEl = document.querySelector('a-scene');
        const infoPanel = document.getElementById('info-panel');
        const lightCurvePanel = document.getElementById('light-curve-panel');
        const astroPanel = document.getElementById('astro-panel');
        const aiPanel = document.getElementById('ai-panel');
        const allPanels = [infoPanel, lightCurvePanel, astroPanel, aiPanel];
        let activePlanet = null;
        let planetsDataStore = [];
        let lightCurveInterval = null;

        // --- Ana Başlatıcı ---
        window.addEventListener('load', () => {
            fetchPlanetsAndCreateScene();
        });

        // --- Yardımcı Fonksiyonlar ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function animateAIProgress(confidenceString) {
            const confidenceValue = parseFloat(confidenceString.replace('%', ''));
            const totalWidth = 1.8;
            const targetWidth = (confidenceValue / 100) * totalWidth;
            const aiProgressBar = document.getElementById('ai-progress-bar');
            const aiProgressText = document.getElementById('ai-progress-text');
            aiProgressBar.setAttribute('width', 0);
            aiProgressBar.setAttribute('position', {x: -totalWidth / 2, y: -0.1, z: 0.02});
            aiProgressBar.setAttribute('animation', { property: 'width', to: targetWidth, dur: 1500, easing: 'easeOutCubic' });
            let start = 0;
            const duration = 1500;
            const stepTime = 20;
            const increment = confidenceValue / (duration / stepTime);
            const timer = setInterval(() => {
                start += increment;
                if (start > confidenceValue) { start = confidenceValue; clearInterval(timer); }
                aiProgressText.setAttribute('value', `${start.toFixed(2)}%`);
            }, stepTime);
        }
        function animateLightCurve(planetInfo) {
            if (lightCurveInterval) clearInterval(lightCurveInterval);
            const lightCurvePath = document.getElementById('light-curve-path');
            lightCurvePath.innerHTML = '';
            const numPoints = 100; const width = 2.0; const baseHeight = 0.2;
            const transitDepth = Math.min(planetInfo.depth / 15000, 0.25) || 0.15;
            const transitDurationRatio = Math.min(planetInfo.duration / 12, 0.3) || 0.2;
            const startDip = (1 - transitDurationRatio) / 2; const endDip = 1 - startDip;
            for (let i = 0; i < numPoints; i++) {
                const x = -width / 2 + (i / (numPoints - 1)) * width; let y = baseHeight;
                if(i / numPoints > startDip && i / numPoints < endDip) { y -= transitDepth; }
                const dot = document.createElement('a-sphere'); dot.setAttribute('radius', '0.008');
                dot.setAttribute('position', `${x} ${y} 0.02`); dot.setAttribute('color', '#00ffff');
                dot.setAttribute('material', 'opacity: 0.3'); lightCurvePath.appendChild(dot);
            }
            let currentPoint = 0;
            lightCurveInterval = setInterval(() => {
                const progress = currentPoint / numPoints; const x = -width / 2 + progress * width;
                let y = baseHeight; let tracerColor = '#00ffff';
                if(progress > startDip && progress < endDip) { y -= transitDepth; tracerColor = '#ff00ff'; }
                const lightCurveTracer = document.getElementById('light-curve-tracer');
                lightCurveTracer.setAttribute('position', `${x} ${y} 0.03`);
                lightCurveTracer.setAttribute('material', `color: ${tracerColor}`);
                currentPoint++; if (currentPoint > numPoints) { currentPoint = 0; }
            }, 50);
        }

        // --- Ana Fonksiyonlar ---
        function fetchPlanetsAndCreateScene() {
            fetch('/get-random-planets')
                .then(response => response.json())
                .then(planets => {
                    planetsDataStore = planets;
                    createExoplanetScene(planets);
                })
                .catch(error => console.error('Gezegen verileri alınamadı:', error));
        }

        function createExoplanetScene(planets) {
            planetsContainer.innerHTML = '';
            const exoplanetTextures = ['#tex1', '#tex2', '#tex3', '#tex4', '#tex5', '#tex6', '#tex7', '#tex8', '#tex9', '#tex10'];
            shuffleArray(exoplanetTextures);
            planets.forEach((planet, index) => {
                const orbitRadius = 8 + index * 4;
                const planetRadius = planet.planet_radius ? Math.min(planet.planet_radius * 0.4, 3.5) : 0.5;
                const calculatedDuration = planet.period ? planet.period * 8000 : 80000;
                const orbitDuration = Math.max(calculatedDuration, 60000);
                const uniqueTextureId = exoplanetTextures[index];
                const orbit = document.createElement("a-entity");
                orbit.setAttribute("animation", `property: rotation; to: 0 360 0; loop: true; dur: ${orbitDuration}; easing: linear`);
                const el = document.createElement("a-sphere");
                el.setAttribute("position", `${orbitRadius} 0 0`);
                el.setAttribute("radius", planetRadius);
                el.setAttribute("material", `shader: standard; src: ${uniqueTextureId}`);
                el.classList.add("planet");
                el.dataset.planetIndex = index;
                // DÜZELTME: Belirttiğiniz olası tırnak hatası da dahil tüm satırlar kontrol edildi.
                el.setAttribute("animation__spin", "property: rotation; to: 0 360 0; loop: true; dur: 15000; easing: linear");
                
                // YENİ: Gezegen Adı Etiketi
                const label = document.createElement('a-text');
                label.setAttribute('value', planet.planet_name);
                label.setAttribute('color', 'white');
                label.setAttribute('align', 'center');
                label.setAttribute('width', 10);
                const labelYPosition = planetRadius + 0.5;
                label.setAttribute('position', `0 ${labelYPosition} 0`);
                label.setAttribute('look-at', '[camera]');
                el.appendChild(label);

                el.addEventListener('click', (evt) => {
                    showExoplanetInfo(evt.target.dataset.planetIndex);
                });
                orbit.appendChild(el);
                const orbitRing = document.createElement("a-ring");
                orbitRing.setAttribute("position", "0 0 0");
                orbitRing.setAttribute("rotation", "-90 0 0");
                orbitRing.setAttribute("radius-inner", orbitRadius - 0.01);
                orbitRing.setAttribute("radius-outer", orbitRadius + 0.01);
                orbitRing.setAttribute("material", "color: #555; opacity: 0.3; shader: flat;");
                planetsContainer.appendChild(orbit);
                planetsContainer.appendChild(orbitRing);
            });
        }
        
        // GÜNCELLEME: Panel animasyonlarını yönetecek şekilde güncellendi
        function showExoplanetInfo(planetIndex) {
            const planetInfo = planetsDataStore[planetIndex];
            if (!planetInfo) return;

            if (activePlanet === planetInfo.planet_name) {
                // Panelleri kapatma animasyonunu tetikle
                allPanels.forEach(p => p.emit('close-panels'));
                // Animasyon bittikten sonra panelleri tamamen gizle
                setTimeout(() => {
                    allPanels.forEach(p => p.setAttribute('visible', 'false'));
                }, 350); // Animasyon süresinden biraz uzun tutuyoruz

                if (lightCurveInterval) clearInterval(lightCurveInterval);
                activePlanet = null;
            } else {
                // Panelleri önce görünür yap, sonra açılma animasyonunu tetikle
                allPanels.forEach(p => p.setAttribute('visible', 'true'));
                allPanels.forEach(p => p.emit('open-panels'));

                activePlanet = planetInfo.planet_name;
                const infoTitle = document.getElementById('info-title');
                const infoText = document.getElementById('info-text');
                const astroText = document.getElementById('astro-text');
                infoTitle.setAttribute('value', planetInfo.planet_name.toUpperCase());
                infoText.setAttribute('value', `"${planetInfo.description}"`);
                const details = planetInfo.astro_details;
                astroText.setAttribute('value', `Discovery Year: ${details.discovery_year}\nEst. Mass: ${details.estimated_mass}\nEst. Temp: ${details.surface_temp}\nComposition: ${details.composition}`);
                animateLightCurve(planetInfo);
                const predictionText = planetInfo.ai_confidence >= 15 ? 'PLANET CANDIDATE' : 'LOW PROBABILITY';
                const finalInfo = `"${planetInfo.description}"\n\n` + `AI STATUS: ${predictionText}`;
                infoText.setAttribute('value', finalInfo);
                animateAIProgress(planetInfo.ai_confidence.toFixed(2) + '%');
            }
        }

        sceneEl.addEventListener('click', function (evt) {
            if (evt.detail.intersectedEl && evt.detail.intersectedEl.classList.contains('planet')) {
                showExoplanetInfo(evt.detail.intersectedEl.dataset.planetIndex);
            }
        });
        document.querySelectorAll('[laser-controls]').forEach(controller => {
            controller.addEventListener('triggerdown', function(evt) {
                const intersected = this.components.raycaster.intersectedEls[0];
                if (intersected && intersected.classList.contains('planet')) {
                    showExoplanetInfo(intersected.dataset.planetIndex);
                }
            });
        });
    </script>
  </a-scene>
</body>
</html>
